{% extends "admin/base_admin.html" %}

{% block title %}Gestionar Ventas{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Historial de Ventas</h2>
    <a href="{{ url_for('admin.crear_venta') }}" class="btn btn-primary">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-lg" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"/>
        </svg>
        Registrar Nueva Venta
    </a>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <table class="table table-hover mb-0">
            <thead>
            <tr>
                <th scope="col">ID</th>
                <th scope="col">Cliente</th>
                <th scope="col">Fecha</th>
                <th scope="col" class="text-end">Monto Total</th>
                <th scope="col">Estado</th>
                <th scope="col" class="text-end">Acciones</th>
            </tr>
            </thead>
            <tbody>
            {% for venta in ventas %}
            <tr class="{{ 'table-danger' if venta.estado == 'Anulada' else '' }}">
                <th scope="row">#{{ venta.id }}</th>
                <td>{{ venta.cliente.nombre }} {{ venta.cliente.apellido or '' }}</td>
                <td>{{ venta.fecha_venta.strftime('%Y-%m-%d') }}</td>
                <td class="text-end">${{ "%.2f"|format(venta.monto_total) }}</td>
                <td>
                            <span class="badge
                                {% if venta.estado == 'Pagada' %}bg-success
                                {% elif venta.estado == 'Pendiente' %}bg-warning text-dark
                                {% elif venta.estado == 'En Proceso' %}bg-info text-dark
                                {% elif venta.estado == 'Anulada' %}bg-danger
                                {% else %}bg-secondary
                                {% endif %}"
                                  {% if venta.estado == 'Anulada' %}
                    data-bs-toggle="tooltip"
                    data-bs-placement="top"
                    title="Anulada por {{ venta.anulada_por.nombre }} el {{ venta.fecha_anulacion.strftime('%Y-%m-%d') }}. Motivo: {{ venta.motivo_anulacion }}"
                    {% endif %}>
                    {{ venta.estado }}
                    </span>
                </td>
                <td class="text-end">
                    {% if venta.estado == 'En Proceso' %}
                    <a href="{{ url_for('admin.editar_venta', id=venta.id) }}" class="btn btn-sm btn-primary">Continuar Venta</a>
                    {% elif venta.estado == 'Anulada' %}
                    <!-- No hay acciones para ventas anuladas, pero se puede ver el detalle -->
                    <a href="{{ url_for('admin.ver_venta', id=venta.id) }}" class="btn btn-sm btn-outline-secondary">Ver Detalles</a>
                    {% else %}
                    <a href="{{ url_for('admin.ver_venta', id=venta.id) }}" class="btn btn-sm btn-outline-info">Ver Detalles y Pagos</a>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6" class="text-center p-4">
                    No hay ventas registradas.
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Script para inicializar los tooltips de Bootstrap -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    });
</script>
{% endblock %}