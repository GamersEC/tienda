{% extends "admin/base_admin.html" %}

{% block title %}Detalle de Venta #{{ venta.id }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Detalle de Venta #{{ venta.id }}</h2>
    <span class="badge fs-6 {% if venta.estado == 'Pagada' %}bg-success{% elif venta.estado == 'Pendiente'%}bg-warning text-dark{% else %}bg-secondary{% endif %}">
            {{ venta.estado }}
        </span>
</div>
<p class="lead">
    <strong>Cliente:</strong> {{ venta.cliente.nombre }} {{ venta.cliente.apellido or '' }} |
    <strong>Fecha:</strong> {{ venta.fecha_venta.strftime('%Y-%m-%d %H:%M') }}
</p>
<hr>

<div class="row g-4">
    <!-- Columna Izquierda: Resumen Financiero y Productos -->
    <div class="col-lg-7">
        <div class="card mb-4">
            <div class="card-header"><h4>Resumen Financiero</h4></div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between"><strong>Monto Total:</strong> <span>${{ "%.2f"|format(venta.monto_total) }}</span></li>
                    <li class="list-group-item d-flex justify-content-between"><strong>Total Pagado:</strong> <span class="text-success">${{ "%.2f"|format(total_pagado) }}</span></li>
                    <li class="list-group-item d-flex justify-content-between"><strong>Saldo Pendiente:</strong> <strong class="text-danger">${{ "%.2f"|format(venta.monto_total - total_pagado) }}</strong></li>
                </ul>
                {% if venta.monto_total > 0 %}
                <div class="progress mt-3" style="height: 25px;">
                    {% set porcentaje_pagado = (total_pagado / venta.monto_total) * 100 %}
                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ porcentaje_pagado }}%;" aria-valuenow="{{ porcentaje_pagado }}" aria-valuemin="0" aria-valuemax="100">
                        {{ "%.0f"|format(porcentaje_pagado) }}% Pagado
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-header"><h4>Productos Vendidos</h4></div>
            <div class="card-body">
                <table class="table table-sm">
                    <tbody>
                    {% for item in venta.productos_asociados %}
                    <tr>
                        <td>{{ item.producto.nombre }}</td>
                        <td>{{ item.cantidad }} x ${{ "%.2f"|format(item.precio_unitario) }}</td>
                        <td class="text-end">${{ "%.2f"|format(item.cantidad * item.precio_unitario) }}</td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% if venta.notas %}
        <div class="card mt-4">
            <div class="card-header"><h4>Notas</h4></div>
            <div class="card-body">
                <p class="fst-italic">{{ venta.notas | replace('\n', '<br>') | safe }}</p>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Columna Derecha: Pagos -->
    <div class="col-lg-5">
        {% if venta.estado != 'Pagada' %}
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h4>Registrar Pago (Entrada / Abono)</h4>
            </div>
            <div class="card-body">
                <form action="{{ url_for('admin.agregar_pago', id=venta.id) }}" method="post" novalidate>
                    {{ pago_form.hidden_tag() }}
                    <div class="mb-3">
                        {{ pago_form.monto_pago.label(class="form-label") }}
                        {{ pago_form.monto_pago(class="form-control form-control-lg") }}
                    </div>
                    <div class="mb-3">
                        {{ pago_form.metodo_pago.label(class="form-label") }}
                        {{ pago_form.metodo_pago(class="form-select") }}
                    </div>
                    <div class="d-grid">
                        {{ pago_form.submit(class="btn btn-primary btn-lg") }}
                    </div>
                </form>
            </div>
        </div>
        {% endif %}

        <div class="card">
            <div class="card-header"><h4>Historial de Pagos</h4></div>
            <div class="card-body">
                <table class="table table-striped">
                    <tbody>
                    {% for pago in venta.pagos %}
                    <tr>
                        <td>{{ pago.fecha_pago.strftime('%Y-%m-%d') }}</td>
                        <td>{{ pago.metodo_pago }}</td>
                        <td class="text-end">${{ "%.2f"|format(pago.monto_pago) }}</td>
                    </tr>
                    {% else %}
                    <tr><td>No hay pagos registrados.</td></tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<a href="{{ url_for('admin.listar_ventas') }}" class="btn btn-secondary mt-4">&larr; Volver a la Lista de Ventas</a>
{% endblock %}