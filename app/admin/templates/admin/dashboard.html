{% extends "admin/base_admin.html" %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Dashboard Analítico</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <button type="button" class="btn btn-sm btn-outline-secondary">Últimos 30 días</button>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header"><h5 class="mb-0">Resumen Financiero (Últimos 30 días)</h5></div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <div><i class="fas fa-arrow-down text-success me-2"></i> Ingresos Brutos</div>
                            <span class="fw-bold fs-5 text-success">+ ${{ "%.2f"|format(ingresos_brutos_mes) }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <div><i class="fas fa-undo text-warning me-2"></i> (-) Reembolsos por Devolución</div>
                            <span class="fw-bold fs-5 text-warning">- ${{ "%.2f"|format(reembolsos_mes) }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center bg-light px-2 py-2">
                            <strong class="text-primary">= Ingresos Netos</strong>
                            <span class="fw-bold fs-5 text-primary">${{ "%.2f"|format(ingresos_netos_mes) }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <div><i class="fas fa-arrow-up text-danger me-2"></i> (-) Gastos Operativos</div>
                            <span class="fw-bold fs-5 text-danger">- ${{ "%.2f"|format(gastos_operativos_mes) }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center bg-dark text-white px-2 py-2">
                            <strong class="fs-5">= Beneficio Neto</strong>
                            <span class="fw-bold fs-4">${{ "%.2f"|format(beneficio_neto_mes) }}</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="row g-4 h-100">
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-body text-center">
                            <h5 class="card-title">Ingresos de Hoy</h5>
                            <p class="display-4 text-primary fw-bold">${{ "%.2f"|format(ingresos_hoy) }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-body text-center">
                            <h5 class="card-title">Ventas de Hoy</h5>
                            <p class="display-4 text-info fw-bold">{{ ventas_hoy }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header"><h5 class="mb-0">Ingresos Brutos en los Últimos 30 Días</h5></div>
        <div class="card-body"><canvas id="salesChart" width="400" height="120"></canvas></div>
    </div>

    <div class="row g-4">
        <div class="col-lg-6 col-xl-3">
            <div class="card shadow-sm h-100"><div class="card-header bg-success text-white"><h5 class="mb-0">Top 5 Productos Vendidos</h5></div><div class="table-responsive"><table class="table table-hover mb-0"><thead><tr><th>Producto</th><th class="text-end">Cantidad</th></tr></thead><tbody>{% for producto, total_cantidad in top_productos %}<tr><td>{{ producto.nombre }}</td><td class="text-end fw-bold">{{ total_cantidad }}</td></tr>{% else %}<tr><td colspan="2" class="text-center">No hay datos suficientes.</td></tr>{% endfor %}</tbody></table></div></div>
        </div>
        <div class="col-lg-6 col-xl-3">
            <div class="card shadow-sm h-100"><div class="card-header bg-primary text-white"><h5 class="mb-0">Top 5 Clientes</h5></div><div class="table-responsive"><table class="table table-hover mb-0"><thead><tr><th>Cliente</th><th class="text-end">Total Gastado</th></tr></thead><tbody>{% for cliente, total_gastado in top_clientes %}<tr><td>{{ cliente.nombre }} {{ cliente.apellido or ''}}</td><td class="text-end fw-bold">${{ "%.2f"|format(total_gastado) }}</td></tr>{% else %}<tr><td colspan="2" class="text-center">No hay datos suficientes.</td></tr>{% endfor %}</tbody></table></div></div>
        </div>
        <div class="col-lg-6 col-xl-3">
            <div class="card shadow-sm h-100"><div class="card-header bg-danger text-white"><h5 class="mb-0">Top 5 Categorías de Gasto</h5></div><div class="table-responsive"><table class="table table-hover mb-0"><thead><tr><th>Categoría</th><th class="text-end">Total Gastado</th></tr></thead><tbody>{% for categoria, total_gastado in top_categorias_gasto %}<tr><td>{{ categoria }}</td><td class="text-end fw-bold">${{ "%.2f"|format(total_gastado) }}</td></tr>{% else %}<tr><td colspan="2" class="text-center">No hay gastos registrados.</td></tr>{% endfor %}</tbody></table></div></div>
        </div>
        <div class="col-lg-6 col-xl-3">
            <div class="card shadow-sm h-100"><div class="card-header bg-warning"><h5 class="mb-0">Productos con Bajo Stock</h5></div><div class="table-responsive"><table class="table table-hover mb-0"><thead><tr><th>Producto</th><th class="text-end">Stock</th></tr></thead><tbody>{% for producto in productos_bajo_stock %}<tr><td>{{ producto.nombre }}</td><td class="text-end text-danger fw-bold">{{ producto.stock }}</td></tr>{% else %}<tr><td colspan="2" class="text-center">Inventario en orden.</td></tr>{% endfor %}</tbody></table></div></div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const ctx = document.getElementById('salesChart').getContext('2d');
            const chartLabels = {{ chart_labels | tojson | safe }};
            const chartData = {{ chart_data | tojson | safe }};
            const salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Ingresos Brutos por Día ($)',
                        data: chartData,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) { return '$' + value.toLocaleString(); }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) { label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(context.parsed.y); }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        });
    </script>
{% endblock %}